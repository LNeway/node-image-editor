<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPU Pipeline Demo - Node Image Editor</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Inter, system-ui, -apple-system, sans-serif; background: #1e1e1e; color: #fff; min-height: 100vh; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; }
    header { margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #3d3d3d; }
    h1 { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
    .subtitle { color: #b0b0b0; font-size: 14px; }
    .main-content { display: grid; grid-template-columns: 320px 1fr; gap: 24px; }
    .panel { background: #2d2d2d; border-radius: 8px; padding: 16px; }
    .panel-title { font-size: 14px; font-weight: 600; margin-bottom: 16px; color: #b0b0b0; text-transform: uppercase; letter-spacing: 0.5px; }
    .control-group { margin-bottom: 16px; }
    .control-label { display: block; font-size: 13px; margin-bottom: 6px; color: #b0b0b0; }
    input[type="file"] { width: 100%; padding: 8px; background: #3d3d3d; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 13px; }
    input[type="range"] { width: 100%; height: 6px; background: #3d3d3d; border-radius: 3px; outline: none; -webkit-appearance: none; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: #00b894; border-radius: 50%; cursor: pointer; }
    .value-display { display: inline-block; float: right; color: #00b894; font-size: 13px; }
    select { width: 100%; padding: 8px; background: #3d3d3d; border: 1px solid #404040; border-radius: 4px; color: #fff; font-size: 13px; }
    button { width: 100%; padding: 10px 16px; background: #00b894; border: none; border-radius: 4px; color: #fff; font-size: 14px; font-weight: 500; cursor: pointer; transition: background 0.2s; }
    button:hover { background: #00a383; }
    button:disabled { background: #3d3d3d; color: #666; cursor: not-allowed; }
    button.secondary { background: #3d3d3d; }
    button.secondary:hover { background: #4d4d4d; }
    .canvas-container { display: flex; flex-direction: column; gap: 16px; }
    .canvas-wrapper { position: relative; background: #000; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; min-height: 400px; }
    canvas { max-width: 100%; max-height: 600px; }
    .canvas-label { position: absolute; top: 12px; left: 12px; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 4px; font-size: 12px; color: #b0b0b0; }
    .placeholder { color: #666; font-size: 14px; }
    .info-bar { display: flex; gap: 16px; padding: 12px; background: #3d3d3d; border-radius: 4px; font-size: 12px; color: #b0b0b0; flex-wrap: wrap; }
    .info-item { display: flex; align-items: center; gap: 6px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #666; }
    .status-dot.active { background: #00b894; }
    .status-dot.error { background: #e74c3c; }
    .divider { height: 1px; background: #3d3d3d; margin: 16px 0; }
    .log-panel { background: #1a1a1a; border-radius: 4px; padding: 12px; font-family: monospace; font-size: 11px; max-height: 150px; overflow-y: auto; }
    .log-entry { padding: 2px 0; color: #888; }
    .log-entry.info { color: #4fc3f7; }
    .log-entry.success { color: #81c784; }
    .log-entry.error { color: #e57373; }
    .node-preview { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px; }
    .node-preview-item { background: #3d3d3d; border-radius: 4px; padding: 8px; text-align: center; font-size: 11px; }
    .node-preview-item canvas { max-width: 100%; height: auto; }
    @media (max-width: 900px) { .main-content { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>GPU Pipeline Demo - Phase 2</h1>
      <p class="subtitle">Redux Store + Execution Engine Test</p>
    </header>

    <div class="main-content">
      <div class="panel">
        <div class="panel-title">Controls</div>

        <div class="control-group">
          <label class="control-label">1. Upload Image</label>
          <input type="file" id="imageInput" accept="image/*">
        </div>

        <div class="divider"></div>

        <div class="control-group">
          <label class="control-label">2. Add Node</label>
          <button id="addNodeBtn" class="secondary">+ Add Brightness/Contrast Node</button>
        </div>

        <div class="control-group">
          <label class="control-label">3. Adjust Parameters</label>
          <div id="nodeControls" style="display: none;">
            <div class="control-group">
              <label class="control-label">
                Brightness <span class="value-display" id="brightnessValue">0</span>
              </label>
              <input type="range" id="brightness" min="-1" max="1" step="0.01" value="0">
            </div>
            <div class="control-group">
              <label class="control-label">
                Contrast <span class="value-display" id="contrastValue">1</span>
              </label>
              <input type="range" id="contrast" min="0" max="3" step="0.01" value="1">
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="control-group">
          <button id="executeBtn" disabled>Execute Pipeline</button>
        </div>

        <div class="control-group">
          <button id="exportBtn" disabled>Export Result</button>
        </div>

        <div class="divider"></div>

        <div class="info-bar">
          <div class="info-item">
            <span class="status-dot" id="webglStatus"></span>
            <span>WebGL2</span>
          </div>
          <div class="info-item">
            <span>Nodes: <span id="nodeCount">0</span></span>
          </div>
          <div class="info-item">
            <span>Pool: <span id="poolSize">0</span>/30</span>
          </div>
        </div>

        <div class="divider"></div>

        <div class="panel-title">Execution Log</div>
        <div class="log-panel" id="logPanel"></div>
      </div>

      <div class="canvas-container">
        <div class="canvas-wrapper">
          <span class="canvas-label">Output Preview</span>
          <canvas id="outputCanvas"></canvas>
          <div class="placeholder" id="placeholder">Upload an image to start</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Import GPU components
    import { GPUContext, createGPUContext } from '../../src/core/gpu/index.js';
    import { ExecutionEngine, getExecutionEngine } from '../../src/core/engine/ExecutionEngine.js';
    import { nodeRegistry } from '../../src/core/nodes/NodeRegistry.js';
    import { BrightnessContrastNode } from '../../src/core/nodes/adjust/BrightnessContrastNode.js';

    // Vertex Shader
    const vertexShader = `#version 300 es
precision highp float;
in vec2 a_position;
in vec2 a_texcoord;
out vec2 vUv;
void main() {
  vUv = a_texcoord;
  gl_Position = vec4(a_position, 0.0, 1.0);
}`;

    // Fragment Shaders
    const passthroughShader = `#version 300 es
precision highp float;
uniform sampler2D u_texture;
in vec2 vUv;
out vec4 fragColor;
void main() {
  fragColor = texture(u_texture, vUv);
}`;

    const brightnessContrastShader = `#version 300 es
precision highp float;
uniform sampler2D u_texture;
uniform float u_brightness;
uniform float u_contrast;
in vec2 vUv;
out vec4 fragColor;
void main() {
  vec4 color = texture(u_texture, vUv);
  color.rgb += u_brightness;
  color.rgb = (color.rgb - 0.5) * u_contrast + 0.5;
  fragColor = clamp(color, 0.0, 1.0);
}`;

    // State
    let gpuContext = null;
    let executionEngine = null;
    let inputTexture = null;
    let outputTexture = null;
    let imageWidth = 0;
    let imageHeight = 0;
    let nodeId = null;
    let params = { brightness: 0, contrast: 1 };

    // DOM elements
    const imageInput = document.getElementById('imageInput');
    const addNodeBtn = document.getElementById('addNodeBtn');
    const nodeControls = document.getElementById('nodeControls');
    const executeBtn = document.getElementById('executeBtn');
    const exportBtn = document.getElementById('exportBtn');
    const outputCanvas = document.getElementById('outputCanvas');
    const placeholder = document.getElementById('placeholder');
    const webglStatus = document.getElementById('webglStatus');
    const nodeCount = document.getElementById('nodeCount');
    const poolSizeEl = document.getElementById('poolSize');
    const logPanel = document.getElementById('logPanel');

    // Logging
    function log(msg, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logPanel.appendChild(entry);
      logPanel.scrollTop = logPanel.scrollHeight;
    }

    // Initialize
    function init() {
      try {
        // Create GPU Context
        gpuContext = createGPUContext(outputCanvas);
        
        // Register shaders
        gpuContext.createProgram('passthrough', vertexShader, passthroughShader);
        gpuContext.createProgram('brightness_contrast', vertexShader, brightnessContrastShader);
        
        // Register node
        nodeRegistry.register(BrightnessContrastNode);
        
        // Initialize execution engine
        executionEngine = getExecutionEngine();
        executionEngine.setGPUContext(gpuContext);

        // Listen for execution results
        executionEngine.onExecute((results) => {
          log(`Executed ${results.length} node(s)`, 'success');
          results.forEach(r => {
            if (r.error) {
              log(`  ${r.nodeId}: ${r.error}`, 'error');
            }
          });
        });

        webglStatus.classList.add('active');
        log('GPU Context initialized', 'success');
        log('Execution Engine ready', 'success');
        
        return true;
      } catch (e) {
        console.error('Init failed:', e);
        log(`Init failed: ${e.message}`, 'error');
        webglStatus.classList.add('error');
        return false;
      }
    }

    // Load image
    async function loadImage(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }

    // Execute pipeline
    function executePipeline() {
      if (!executionEngine || !inputTexture || !nodeId) return;

      const nodes = [{
        id: nodeId,
        type: 'brightness_contrast',
        position: { x: 100, y: 100 },
        data: params
      }];

      const edges = [];

      executionEngine.setGraph(nodes, edges);
      executionEngine.markAllDirty();

      // Get result
      const result = executionEngine.getNodeResult(nodeId);
      if (result?.image?.texture) {
        outputTexture = result.image.texture;
        gpuContext.copyToCanvas(outputTexture, outputCanvas);
        log('Pipeline executed successfully', 'success');
      }

      poolSizeEl.textContent = gpuContext.textureManager.getPoolSize();
    }

    // Event handlers
    imageInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        placeholder.style.display = 'none';
        const img = await loadImage(file);

        if (!gpuContext && !init()) return;

        imageWidth = img.width;
        imageHeight = img.height;
        outputCanvas.width = imageWidth;
        outputCanvas.height = imageHeight;

        // Upload to GPU
        inputTexture = gpuContext.uploadTexture(img, { name: 'input' });

        // Display input
        gpuContext.copyToCanvas(inputTexture, outputCanvas);

        log(`Image loaded: ${img.width}x${img.height}`, 'success');
        executeBtn.disabled = false;
        exportBtn.disabled = false;
        addNodeBtn.disabled = false;

        poolSizeEl.textContent = gpuContext.textureManager.getPoolSize();
      } catch (e) {
        log(`Failed to load image: ${e.message}`, 'error');
      }
    });

    addNodeBtn.addEventListener('click', () => {
      nodeId = 'node_' + Date.now();
      nodeControls.style.display = 'block';
      addNodeBtn.disabled = true;
      nodeCount.textContent = '1';
      log('Added Brightness/Contrast node', 'info');
    });

    // Parameter sliders
    ['brightness', 'contrast'].forEach(id => {
      const el = document.getElementById(id);
      const display = document.getElementById(id + 'Value');
      el.addEventListener('input', () => {
        display.textContent = el.value;
        params[id] = parseFloat(el.value);
      });
    });

    executeBtn.addEventListener('click', executePipeline);

    exportBtn.addEventListener('click', async () => {
      if (!outputTexture) return;

      try {
        const blob = await gpuContext.exportToBlob(outputTexture, 'png');
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'output.png';
        a.click();
        URL.revokeObjectURL(url);
        log('Image exported', 'success');
      } catch (e) {
        log(`Export failed: ${e.message}`, 'error');
      }
    });

    // Start
    init();
  </script>
</body>
</html>
